<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de PDF de Documentos</title>

  <!-- Ajustes para mobile e PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#007bff">
  <link rel="manifest" href="manifest.json">

  <!-- Tesseract.js (OCR no navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- Dados de idioma português -->
  <script src="https://cdn.jsdelivr.net/npm/@tesseract.js-data/por@1.0.0/index.min.js"></script>
  <!-- jsPDF (gerar PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 8px;
    }
    p.descricao {
      font-size: 14px;
      text-align: center;
      color: #555;
      margin-top: 0;
      margin-bottom: 12px;
    }
    input[type="file"] {
      width: 100%;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    button {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 4px;
      border: none;
      background: #007bff;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    button:hover:enabled {
      background: #0056b3;
    }
    #status {
      margin-top: 10px;
      font-size: 13px;
      color: #333;
      white-space: pre-line;
    }
    #resultados {
      margin-top: 16px;
      padding-left: 0;
      list-style: none;
      font-size: 14px;
    }
    #resultados li {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      background: #f8f9fa;
      border: 1px solid #ddd;
    }
    .tipo {
      font-weight: bold;
    }
    a.download-link {
      display: inline-block;
      margin-top: 6px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #28a745;
      color: #fff;
      text-decoration: none;
      font-size: 13px;
    }
    a.download-link:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gerador de PDF de Documentos</h1>
    <p class="descricao">
      Selecione imagens (RG, CPF, holerite, comprovante etc.).<br>
      O app tenta identificar o tipo e gera um PDF para cada imagem.
    </p>

    <input id="fileInput" type="file" multiple accept="image/*">
    <button id="btnProcessar" onclick="processarImagens()">Processar imagens</button>

    <div id="status"></div>
    <ul id="resultados"></ul>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    function lerArquivoComoDataURL(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(arquivo);
      });
    }

    function identificarTipoDocumento(texto) {
      const t = (texto || "").toLowerCase();

      const ehRG =
        t.includes("carteira de identidade") ||
        t.includes("registro geral") ||
        /\brg\b/.test(t);

      const ehCPF =
        t.includes("cadastro de pessoas fisicas") ||
        t.includes("cadastro de pessoas físicas") ||
        /\bcpf\b/.test(t);

      const ehHolerite =
        t.includes("holerite") ||
        t.includes("contracheque") ||
        t.includes("contra cheque") ||
        t.includes("contra-cheque");

      const ehComprovante =
        t.includes("comprovante de residência") ||
        t.includes("comprovante de residencia") ||
        t.includes("conta de energia") ||
        t.includes("conta de luz") ||
        t.includes("conta de água") ||
        t.includes("conta de agua") ||
        t.includes("conta de telefone") ||
        t.includes("conta de internet") ||
        t.includes("endereço") ||
        t.includes("endereco");

      if (ehRG) return "RG";
      if (ehCPF) return "CPF";
      if (ehHolerite) return "HOLERITE";
      if (ehComprovante) return "COMPROVANTE_RESIDENCIA";
      return "DESCONHECIDO";
    }

    async function processarImagens() {
      const input = document.getElementById("fileInput");
      const statusEl = document.getElementById("status");
      const resultadosEl = document.getElementById("resultados");
      const btn = document.getElementById("btnProcessar");

      const arquivos = input.files;
      if (!arquivos || arquivos.length === 0) {
        alert("Selecione pelo menos uma imagem.");
        return;
      }

      resultadosEl.innerHTML = "";
      statusEl.textContent = "Iniciando processamento...\nIsso pode levar alguns segundos por imagem.";
      btn.disabled = true;

      const contadorPorTipo = {};

      for (let i = 0; i < arquivos.length; i++) {
        const arquivo = arquivos[i];
        statusEl.textContent += `\nProcessando: ${arquivo.name}...`;

        try {
          const dataURL = await lerArquivoComoDataURL(arquivo);

          const resultadoOCR = await Tesseract.recognize(dataURL, "por");
          const texto = resultadoOCR.data.text || "";
          const tipo = identificarTipoDocumento(texto);

          contadorPorTipo[tipo] = (contadorPorTipo[tipo] || 0) + 1;
          const numero = String(contadorPorTipo[tipo]).padStart(2, "0");
          const nomePdf = `${tipo}_${numero}.pdf`;

          const pdf = new jsPDF({
            orientation: "portrait",
            unit: "pt",
            format: "a4"
          });

          const img = new Image();
          img.src = dataURL;
          await new Promise((resolve, reject) => {
            img.onload = () => resolve();
            img.onerror = e => reject(e);
          });

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
          const imgWidth = img.width * ratio;
          const imgHeight = img.height * ratio;
          const x = (pageWidth - imgWidth) / 2;
          const y = (pageHeight - imgHeight) / 2;

          let formatoImg = "JPEG";
          if (arquivo.type.includes("png")) {
            formatoImg = "PNG";
          }

          pdf.addImage(img, formatoImg, x, y, imgWidth, imgHeight);

          const blob = pdf.output("blob");
          const url = URL.createObjectURL(blob);

          const li = document.createElement("li");
          li.innerHTML = `
            <div><strong>Arquivo:</strong> ${arquivo.name}</div>
            <div><span class="tipo">Tipo:</span> ${tipo}</div>
            <div><strong>PDF:</strong> ${nomePdf}</div>
          `;
          const link = document.createElement("a");
          link.href = url;
          link.download = nomePdf;
          link.className = "download-link";
          link.textContent = "Baixar PDF";

          li.appendChild(link);
          resultadosEl.appendChild(li);

        } catch (erro) {
          console.error(erro);
          const li = document.createElement("li");
          li.innerHTML = `
            <div><strong>Arquivo:</strong> ${arquivo.name}</div>
            <div style="color:#c00;"><strong>Erro:</strong> ${erro.message || erro}</div>
          `;
          resultadosEl.appendChild(li);
        }
      }

      statusEl.textContent += `\n\nConcluído! Toque em “Baixar PDF” em cada linha.`;
      btn.disabled = false;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('service-worker.js')
          .catch(err => console.log('Erro ao registrar service worker', err));
      });
    }
  </script>
</body>
</html>
